<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arsip Laporan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .header { background: #343a40; color: white; padding: 15px 20px; display: flex; align-items: center; position: sticky; top:0; z-index:100; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .card-history { background: white; border-radius: 10px; padding: 15px; margin: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #ccc; }
        
        .status-approved { border-left-color: #28a745; }
        .status-rejected { border-left-color: #dc3545; }
        .status-revoked { border-left-color: #000; background: #e9ecef; }
        .btn-revoke { font-size: 0.75rem; padding: 5px 10px; margin-top: 5px; border-radius: 20px; border: 1px solid #343a40; color: #343a40; background:transparent;}
        .btn-revoke:hover { background: #343a40; color: white; }
    </style>
</head>
<body>

    <div class="header">
        <i class="fas fa-arrow-left me-3" onclick="history.back()" style="cursor:pointer; font-size:1.2rem;"></i>
        <span style="font-weight:700; font-size:1.1rem;">Arsip & Audit</span>
    </div>
    
    <div class="p-3 bg-white border-bottom">
        <input type="text" id="searchBox" class="form-control" placeholder="Cari nama siswa...">
    </div>

    <div id="archiveContainer">
        <div class="text-center p-5 text-muted"><i class="fas fa-spinner fa-spin"></i> Memuat...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, increment, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG SERVER SINGAPURA
        const firebaseConfig = {
            apiKey: "AIzaSyBRGNL4DL5L_x92vv6tI4Ysa9Q0qyKvjeQ",
            authDomain: "pkm-pm-def08.firebaseapp.com",
            databaseURL: "https://pkm-pm-def08-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pkm-pm-def08",
            storageBucket: "pkm-pm-def08.firebasestorage.app",
            messagingSenderId: "1077227616889",
            appId: "1:1077227616889:web:9ce3a57e3d46012acab2a8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let allReports = [];

        onValue(ref(db, 'reports'), (snap) => {
            allReports = [];
            const container = document.getElementById('archiveContainer');
            container.innerHTML = '';

            if(!snap.exists()) {
                container.innerHTML = '<div class="text-center p-5 text-muted">Belum ada arsip laporan.</div>';
                return;
            }

            snap.forEach(c => allReports.push({key:c.key, ...c.val()}));
            
            // SORTING AMAN (Anti-Error)
            // Kalau timestamp tidak ada, pakai 0 biar tidak NaN
            allReports.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            
            renderList(allReports);
        });

        function renderList(list) {
            const container = document.getElementById('archiveContainer');
            container.innerHTML = '';
            
            list.forEach(r => {
                let badge = '', border = '', btn = '';

                if(r.status === 'approved') {
                    badge = '<span class="badge bg-success">Diterima (+50 XP)</span>';
                    border = 'status-approved';
                    btn = `<button class="btn-revoke" onclick="revokeXP('${r.key}','${r.uid}')"><i class="fas fa-ban"></i> Cabut Poin</button>`;
                } else if(r.status === 'rejected') {
                    badge = '<span class="badge bg-danger">Ditolak</span>';
                    border = 'status-rejected';
                } else if(r.status === 'pending') {
                    badge = '<span class="badge bg-warning text-dark">Pending</span>';
                } else if(r.status === 'revoked') {
                    badge = '<span class="badge bg-secondary">DICABUT (SANKSI)</span>';
                    border = 'status-revoked';
                }

                container.innerHTML += `
                    <div class="card-history ${border}">
                        <div class="d-flex justify-content-between">
                            <strong>${r.userName}</strong>
                            <small class="text-muted">${r.date}</small>
                        </div>
                        <div class="small mb-1 fw-bold">${r.bookTitle}</div>
                        <div class="bg-light p-2 rounded small font-italic mb-2 border">"${r.summary}"</div>
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            ${badge} ${btn}
                        </div>
                    </div>
                `;
            });
        }

        document.getElementById('searchBox').addEventListener('input', (e) => {
            const k = e.target.value.toLowerCase();
            renderList(allReports.filter(r => r.userName.toLowerCase().includes(k)));
        });

        window.revokeXP = (key, uid) => {
            Swal.fire({title:'Tarik Poin?', icon:'warning', showCancelButton:true, confirmButtonText:'Ya'}).then(r=>{
                if(r.isConfirmed) {
                    update(ref(db, `reports/${key}`), {status:'revoked'});
                    update(ref(db, `users/${uid}`), {xp: increment(-50)});
                    push(ref(db, `logs/${uid}`), {
                        activity: "SANKSI: Poin Laporan Dicabut", points: -50, date: new Date().toLocaleDateString('id-ID'), timestamp: Date.now()
                    });
                    Swal.fire('Selesai', 'Poin ditarik.', 'success');
                }
            });
        }
    </script>
</body>
</html>
