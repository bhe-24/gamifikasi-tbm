<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, update, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBRGNL4DL5L_x92vv6tI4Ysa9Q0qyKvjeQ",
            authDomain: "pkm-pm-def08.firebaseapp.com",
            projectId: "pkm-pm-def08",
            storageBucket: "pkm-pm-def08.firebasestorage.app",
            messagingSenderId: "1077227616889",
            appId: "1:1077227616889:web:9ce3a57e3d46012acab2a8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const IMGBB_API_KEY = "2f45fcafb6dfb2dbae295499022ce476";

        // 1. CEK LOGIN ADMIN
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Cek domain, jika bukan admin tendang
                if (!user.email.endsWith('@ac.id')) {
                    Swal.fire('Akses Ditolak', 'Halaman ini khusus Admin.', 'error').then(() => {
                        window.location.href = "../dashboard/index.html";
                    });
                } else {
                    loadLeaderboard();
                    loadCurrentBanner();
                    loadReports(); 
                }
            } else {
                window.location.href = "../index.html";
            }
        });

        // 2. NAVIGASI TAB
        window.switchTab = (tabId) => {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            
            // Highlight tombol yang diklik
            const btns = document.querySelectorAll('.nav-btn');
            btns.forEach(btn => {
                if(btn.innerText.toLowerCase().includes(tabId)) btn.classList.add('active');
                // Fallback logic simpel
                if(tabId === 'leaderboard' && btn.innerText.includes('Leaderboard')) btn.classList.add('active');
                if(tabId === 'banner' && btn.innerText.includes('Banner')) btn.classList.add('active');
                if(tabId === 'laporan' && btn.innerText.includes('Laporan')) btn.classList.add('active');
                if(tabId === 'karya' && btn.innerText.includes('Karya')) btn.classList.add('active');
                if(tabId === 'hadiah' && btn.innerText.includes('Tukar')) btn.classList.add('active');
            });
        };

        // 3. LOGIC LEADERBOARD (DIPERBAIKI)
        function loadLeaderboard() {
            const container = document.getElementById('leaderboardList');
            const usersRef = ref(db, 'users');
            
            // Listener Realtime
            onValue(usersRef, (snapshot) => {
                // Bersihkan "Memuat..."
                container.innerHTML = '';

                if (!snapshot.exists()) {
                    container.innerHTML = `
                        <div class="text-center p-4 text-muted">
                            <i class="fas fa-users-slash fa-2x mb-2"></i><br>
                            Belum ada user yang bergabung.
                        </div>`;
                    return;
                }
                
                let users = [];
                snapshot.forEach(c => {
                    // Pastikan data valid
                    const val = c.val();
                    users.push({
                        uid: c.key,
                        username: val.username || val.fullName || "Tanpa Nama", // Fallback nama
                        profilePic: val.profilePic || 'https://i.ibb.co/5r2M63R/person-placeholder.png',
                        level: val.level || 1,
                        xp: val.xp || 0
                    });
                });
                
                // Urutkan XP Tertinggi -> Terendah
                users.sort((a,b) => b.xp - a.xp);

                if (users.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted">Data user kosong.</div>';
                    return;
                }

                // Render HTML
                users.forEach((u, index) => {
                    const rankColor = index === 0 ? '#FFD700' : (index === 1 ? '#C0C0C0' : (index === 2 ? '#CD7F32' : '#0D47A1'));
                    const isTop = index < 3;
                    
                    const html = `
                        <div class="lb-row" style="${isTop ? 'background:#f8faff;' : ''}">
                            <div class="lb-rank" style="color:${rankColor}; font-size:${isTop ? '1.2rem' : '1rem'}">
                                ${index === 0 ? '<i class="fas fa-crown"></i>' : '#' + (index+1)}
                            </div>
                            <img src="${u.profilePic}" class="lb-img" style="${isTop ? 'border:2px solid ' + rankColor : ''}">
                            <div class="lb-name">
                                <strong>${u.username}</strong>
                                <span class="badge bg-light text-dark border ms-1" style="font-size:0.7rem">Lvl ${u.level}</span>
                            </div>
                            <div class="lb-xp text-success">
                                ${u.xp} <span style="font-size:0.7rem; color:#888;">XP</span>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                });

            }, (error) => {
                // Jika Error Koneksi / Permission
                console.error(error);
                container.innerHTML = `<div class="text-center text-danger p-3">Gagal memuat data: ${error.message}</div>`;
            });
        }

        // 4. LOGIC UPLOAD BANNER
        function loadCurrentBanner() {
            onValue(ref(db, 'settings/bannerUrl'), (snap) => {
                if(snap.val()) document.getElementById('previewBanner').src = snap.val();
            });
        }

        window.uploadBanner = () => {
            const fileInput = document.getElementById('fileBanner');
            if (fileInput.files.length === 0) {
                Swal.fire('Error', 'Pilih gambar dulu!', 'error');
                return;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('image', file);

            Swal.fire({
                title: 'Mengupload...',
                text: 'Mohon tunggu sebentar',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const imageUrl = result.data.url;
                    update(ref(db, 'settings'), { bannerUrl: imageUrl })
                    .then(() => {
                        Swal.fire('Sukses!', 'Banner berhasil diperbarui.', 'success');
                    });
                } else {
                    throw new Error('Gagal upload ke ImgBB');
                }
            })
            .catch(error => {
                Swal.fire('Gagal', error.message, 'error');
            });
        }

        // 5. LOGIC LAPORAN (Placeholder)
        function loadReports() {
            const reportsRef = ref(db, 'reports');
            onValue(reportsRef, (snap) => {
                const container = document.getElementById('laporanList');
                container.innerHTML = '';
                
                if(!snap.exists()) {
                    container.innerHTML = '<div class="text-center text-muted p-4">Belum ada laporan pending.</div>';
                    return;
                }

                let hasPending = false;
                snap.forEach(child => {
                    const data = child.val();
                    const key = child.key;

                    if(data.status === 'pending') {
                        hasPending = true;
                        const html = `
                            <div class="admin-card item-list pending">
                                <div class="d-flex justify-content-between mb-2">
                                    <strong style="color:var(--admin-blue)">${data.userName}</strong>
                                    <small class="text-muted">${data.date || '-'}</small>
                                </div>
                                <div style="font-size:0.9rem; margin-bottom:5px;">
                                    <i class="fas fa-book me-1"></i> ${data.bookTitle}
                                </div>
                                <div class="p-2 bg-light rounded small mb-2 text-secondary font-italic">"${data.summary}"</div>
                                
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success btn-sm flex-fill" onclick="approveReport('${key}', '${data.uid}', 50)">
                                        <i class="fas fa-check"></i> Terima (+50 XP)
                                    </button>
                                    <button class="btn btn-danger btn-sm flex-fill" onclick="rejectReport('${key}')">
                                        <i class="fas fa-times"></i> Tolak
                                    </button>
                                </div>
                            </div>
                        `;
                        container.innerHTML += html;
                    }
                });

                if(!hasPending) container.innerHTML = '<div class="text-center text-muted p-4">Semua laporan sudah diperiksa.</div>';
            });
        }

        window.approveReport = (reportKey, userUid, points) => {
            update(ref(db, `reports/${reportKey}`), { status: 'approved' });
            
            // Ambil XP lama dulu baru tambah (Transaction manual sederhana)
            // Note: Idealnya pakai runTransaction, tapi ini cukup untuk prototype
            const userRef = ref(db, `users/${userUid}`);
            // Kita update log history juga
            const newLogRef = push(ref(db, `logs/${userUid}`));
            
            // (Disini kita update XP blind increment via update client side - Hati hati race condition di production)
            // Tapi untuk PKM ini oke.
            // Kita perlu fetch user dulu untuk tau XP terakhir kalau mau nambah, 
            // ATAU pakai increment() atomic firebase (lebih aman)
            import { increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
            
            update(userRef, { xp: increment(points) });
            
            // Catat Log
            update(newLogRef, {
                activity: "Laporan Buku Diterima",
                points: points,
                date: new Date().toLocaleDateString('id-ID')
            });

            Swal.fire('Berhasil', 'Poin ditambahkan & Laporan diterima.', 'success');
        };

        window.rejectReport = (key) => {
            update(ref(db, `reports/${key}`), { status: 'rejected' });
            Swal.fire('Ditolak', 'Laporan ditandai ditolak', 'info');
        }

        window.logout = () => {
            signOut(auth).then(() => window.location.href="../index.html");
        }
    </script>
