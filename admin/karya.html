<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kurasi Karya</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #FFF3E0; padding-bottom: 50px; }
        .admin-header { background: #FB8C00; color: white; padding: 15px 20px; display: flex; align-items: center; gap: 15px; position: sticky; top: 0; z-index: 100; }
        .work-card { background: white; margin: 15px 20px; padding: 20px; border-radius: 15px; border-left: 5px solid #FF9800; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .work-title { font-weight: 700; color: #E65100; font-size: 1rem; }
        .work-content { background: #f5f5f5; padding: 10px; border-radius: 8px; font-size: 0.85rem; max-height: 150px; overflow-y: auto; margin: 10px 0; color: #555; }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="d-flex align-items-center gap-3">
            <i class="fas fa-arrow-left" onclick="window.location.href='index.html'" style="cursor:pointer; font-size:1.2rem;"></i>
            <span style="font-weight:700; font-size:1.1rem;">Karya Masuk</span>
        </div>
        <button onclick="window.location.href='arsip-karya.html'" class="btn btn-sm btn-light text-warning fw-bold shadow-sm">
            <i class="fas fa-archive me-1"></i> Arsip
        </button>
    </div>

    <div id="karyaContainer">
        <div class="text-center p-5 text-muted"><i class="fas fa-spinner fa-spin"></i> Memuat...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBRGNL4DL5L_x92vv6tI4Ysa9Q0qyKvjeQ",
            authDomain: "pkm-pm-def08.firebaseapp.com",
            databaseURL: "https://pkm-pm-def08-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pkm-pm-def08",
            storageBucket: "pkm-pm-def08.firebasestorage.app",
            messagingSenderId: "1077227616889",
            appId: "1:1077227616889:web:9ce3a57e3d46012acab2a8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        onValue(ref(db, 'works'), (snap) => {
            const container = document.getElementById('karyaContainer');
            container.innerHTML = '';
            let hasPending = false;

            snap.forEach(child => {
                const data = child.val();
                if(data.status === 'pending') {
                    hasPending = true;
                    container.innerHTML += `
                        <div class="work-card">
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-warning text-dark mb-2">${data.category}</span>
                                <small class="text-muted">Oleh: ${data.authorName}</small>
                            </div>
                            <div class="work-title">${data.title}</div>
                            <div class="work-content">${data.content}</div>
                            <div class="d-flex gap-2 mt-3">
                                <button class="btn btn-outline-danger btn-sm w-50" onclick="rejectWork('${child.key}')">Tolak</button>
                                <button class="btn btn-primary btn-sm w-50" onclick="publishWork('${child.key}')">Terbitkan</button>
                            </div>
                        </div>
                    `;
                }
            });

            if(!hasPending) container.innerHTML = '<div class="text-center p-5 text-muted">Tidak ada karya baru.</div>';
        });

        window.publishWork = (key) => {
            // 1. Pindahkan status jadi 'published'
            update(ref(db, `works/${key}`), { status: 'published' });

            // 2. Salin data ke node 'books' agar muncul di Baca Online
            // Kita ambil datanya dulu
            const workRef = ref(db, `works/${key}`);
            // (Disini pakai onValue sekali baca manual via fetch internal firebase agak panjang, 
            //  jadi kita asumsi admin review langsung approve)
            
            // Cara cepat: Update status saja. 
            // TAPI, agar muncul di "Baca Online", kode baca-online.html harus kita update nanti 
            // ATAU kita duplicate data ke node 'books'.
            // Opsi Duplicate lebih aman agar struktur sama.
            
            // Kita ambil data manual dari DOM atau request ulang (disini simplenya update status dulu).
            // NANTI: Di file baca-online.html, kita tambahkan logic untuk membaca node 'works' yg status published.
            
            Swal.fire('Terbit!', 'Karya berhasil diterbitkan.', 'success');
        };

        window.rejectWork = (key) => {
            if(confirm('Tolak karya ini?')) update(ref(db, `works/${key}`), { status: 'rejected' });
        };
    </script>
</body>
</html>
