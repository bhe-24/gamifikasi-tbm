<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kelola Hadiah & Penukaran</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #F3E5F5; padding-bottom: 50px; }
        
        /* HEADER PINK/UNGU (Tema Hadiah) */
        .admin-header {
            background: #D81B60; color: white; padding: 15px 20px;
            display: flex; align-items: center; gap: 15px;
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* TABS NAVIGASI */
        .nav-tabs .nav-link { color: #880E4F; font-weight: 600; border: none; }
        .nav-tabs .nav-link.active { color: #D81B60; border-bottom: 3px solid #D81B60; background: transparent; }
        .tab-content { padding: 20px 0; }

        /* LIST HADIAH (MANAJEMEN) */
        .reward-item {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px;
            display: flex; align-items: center; gap: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .reward-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; background: #eee; }
        
        /* LIST PERMINTAAN (REQUEST) */
        .request-card {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px;
            border-left: 5px solid #FFC107; /* Kuning = Pending */
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); animation: slideUp 0.3s ease;
        }
        .req-user { font-weight: 700; color: #333; }
        .req-item { font-size: 0.9rem; color: #D81B60; font-weight: 600; }
        .req-date { font-size: 0.75rem; color: #888; }

        .btn-approve { background: #4CAF50; color: white; border: none; border-radius: 20px; padding: 5px 15px; font-size: 0.85rem; }
        .btn-reject { background: white; color: #F44336; border: 1px solid #F44336; border-radius: 20px; padding: 5px 15px; font-size: 0.85rem; }

        @keyframes slideUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body>

    <div class="admin-header">
        <i class="fas fa-arrow-left" onclick="window.location.href='index.html'" style="cursor:pointer; font-size:1.2rem;"></i>
        <span style="font-weight:700; font-size:1.1rem;">Pusat Hadiah</span>
    </div>

    <div class="container mt-3">
        <ul class="nav nav-tabs nav-fill" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="kelola-tab" data-bs-toggle="tab" data-bs-target="#kelola" type="button">ðŸ“¦ Kelola Hadiah</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="request-tab" data-bs-toggle="tab" data-bs-target="#request" type="button">ðŸ“© Permintaan</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            
            <div class="tab-pane fade show active" id="kelola" role="tabpanel">
                <div class="card p-3 mb-4 shadow-sm border-0">
                    <h6 class="text-primary fw-bold mb-3"><i class="fas fa-plus-circle"></i> Tambah Item Baru</h6>
                    <form id="addRewardForm">
                        <div class="row g-2">
                            <div class="col-8">
                                <input type="text" id="itemName" class="form-control form-control-sm" placeholder="Nama Barang (Cth: Buku Tulis)" required>
                            </div>
                            <div class="col-4">
                                <input type="number" id="itemPoints" class="form-control form-control-sm" placeholder="Harga XP" required>
                            </div>
                            <div class="col-12">
                                <input type="file" id="itemImg" class="form-control form-control-sm" accept="image/*" required>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary btn-sm w-100 fw-bold">SIMPAN HADIAH</button>
                            </div>
                        </div>
                    </form>
                </div>

                <h6 class="small text-muted ms-2">Daftar Hadiah Aktif</h6>
                <div id="rewardsList">
                    <div class="text-center p-4 text-muted">Memuat data...</div>
                </div>
            </div>

            <div class="tab-pane fade" id="request" role="tabpanel">
                <h6 class="small text-muted ms-2 mb-3">Siswa Menunggu Konfirmasi</h6>
                <div id="requestList">
                    <div class="text-center p-4 text-muted"><i class="fas fa-spinner fa-spin"></i> Memuat...</div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, update, remove, increment, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG SERVER SINGAPURA
        const firebaseConfig = {
            apiKey: "AIzaSyBRGNL4DL5L_x92vv6tI4Ysa9Q0qyKvjeQ",
            authDomain: "pkm-pm-def08.firebaseapp.com",
            databaseURL: "https://pkm-pm-def08-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pkm-pm-def08",
            storageBucket: "pkm-pm-def08.firebasestorage.app",
            messagingSenderId: "1077227616889",
            appId: "1:1077227616889:web:9ce3a57e3d46012acab2a8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const IMGBB_API_KEY = "2f45fcafb6dfb2dbae295499022ce476";

        // --- 1. LOGIKA TAMBAH HADIAH ---
        document.getElementById('addRewardForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('itemImg').files[0];
            if(!file) return;

            Swal.fire({title:'Mengupload...', didOpen:()=>Swal.showLoading()});

            // Upload ke ImgBB
            const formData = new FormData(); formData.append('image', file);
            try {
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method:'POST', body:formData });
                const json = await res.json();
                
                if(json.success) {
                    // Simpan ke Firebase
                    await push(ref(db, 'rewards'), {
                        name: document.getElementById('itemName').value,
                        cost: parseInt(document.getElementById('itemPoints').value),
                        imageUrl: json.data.url,
                        timestamp: Date.now()
                    });
                    
                    Swal.fire('Sukses', 'Hadiah ditambahkan ke katalog!', 'success');
                    document.getElementById('addRewardForm').reset();
                }
            } catch(err) { Swal.fire('Error', 'Gagal upload', 'error'); }
        });

        // --- 2. LOGIKA TAMPILKAN LIST HADIAH ---
        onValue(ref(db, 'rewards'), (snap) => {
            const container = document.getElementById('rewardsList');
            container.innerHTML = '';
            
            if(!snap.exists()) {
                container.innerHTML = '<div class="text-center p-4 text-muted">Belum ada hadiah.</div>';
                return;
            }

            snap.forEach(c => {
                const item = c.val();
                container.innerHTML += `
                    <div class="reward-item">
                        <img src="${item.imageUrl}" class="reward-thumb">
                        <div style="flex-grow:1;">
                            <div style="font-weight:700; font-size:0.95rem;">${item.name}</div>
                            <div style="color:#D81B60; font-weight:600; font-size:0.85rem;">${item.cost} XP</div>
                        </div>
                        <button class="btn btn-sm btn-light text-danger" onclick="deleteReward('${c.key}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
        });

        window.deleteReward = (key) => {
            if(confirm('Hapus hadiah ini?')) remove(ref(db, `rewards/${key}`));
        }

        // --- 3. LOGIKA PERMINTAAN PENUKARAN (REQUESTS) ---
        onValue(ref(db, 'redemptions'), (snap) => {
            const container = document.getElementById('requestList');
            container.innerHTML = '';
            let count = 0;

            if(!snap.exists()) {
                container.innerHTML = '<div class="text-center p-4 text-muted">Belum ada permintaan.</div>';
                return;
            }

            snap.forEach(c => {
                const r = c.val();
                // Hanya tampilkan yang Pending
                if(r.status === 'pending') {
                    count++;
                    container.innerHTML += `
                        <div class="request-card">
                            <div class="d-flex justify-content-between">
                                <div class="req-user">${r.userName}</div>
                                <div class="req-date">${r.date}</div>
                            </div>
                            <div class="mb-2">
                                Ingin menukar <span class="req-item">${r.rewardName}</span> 
                                <span class="badge bg-secondary">${r.cost} XP</span>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn-approve flex-grow-1" onclick="processRequest('${c.key}', '${r.uid}', ${r.cost}, true)">
                                    <i class="fas fa-check"></i> Setujui & Potong Poin
                                </button>
                                <button class="btn-reject" onclick="processRequest('${c.key}', '${r.uid}', 0, false)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }
            });

            if(count === 0) container.innerHTML = '<div class="text-center p-4 text-muted">Semua permintaan sudah diproses.</div>';
        });

        // --- 4. EKSEKUSI PERMINTAAN (Approve/Reject) ---
        window.processRequest = async (reqKey, userUid, cost, isApproved) => {
            if(!isApproved) {
                // KALO DITOLAK
                Swal.fire({
                    title: 'Tolak Permintaan?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya, Tolak'
                }).then(async (res) => {
                    if(res.isConfirmed) {
                        await update(ref(db, `redemptions/${reqKey}`), { status: 'rejected' });
                        Swal.fire('Ditolak', 'Permintaan ditolak.', 'info');
                    }
                });
                return;
            }

            // KALO DISETUJUI
            Swal.fire({title:'Memproses...', didOpen:()=>Swal.showLoading()});
            
            try {
                // Cek Poin User Dulu (Validasi Server-side sederhana)
                const userSnap = await get(ref(db, `users/${userUid}`));
                const currentXP = userSnap.val().xp || 0;

                if(currentXP < cost) {
                    Swal.fire('Gagal', `Poin user tidak cukup! (Sisa: ${currentXP})`, 'error');
                    return;
                }

                // 1. Kurangi Poin User
                await update(ref(db, `users/${userUid}`), { xp: increment(-cost) });

                // 2. Update Status Request
                await update(ref(db, `redemptions/${reqKey}`), { status: 'approved' });

                // 3. Catat Log ke Dashboard User
                await push(ref(db, `logs/${userUid}`), {
                    activity: "Penukaran Hadiah Berhasil",
                    points: -cost, // Poin minus (merah)
                    date: new Date().toLocaleDateString('id-ID'),
                    timestamp: Date.now()
                });

                Swal.fire('Berhasil', 'Poin dipotong & Hadiah disetujui. Segera berikan hadiah ke siswa.', 'success');

            } catch(e) {
                console.error(e);
                Swal.fire('Error', 'Terjadi kesalahan sistem.', 'error');
            }
        };
        
        // Tab Bootstrap Logic (Manual fix for some environments)
        const triggerTabList = document.querySelectorAll('#myTab button')
        triggerTabList.forEach(triggerEl => {
            const tabTrigger = new bootstrap.Tab(triggerEl)
            triggerEl.addEventListener('click', event => {
                event.preventDefault()
                tabTrigger.show()
            })
        })
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
