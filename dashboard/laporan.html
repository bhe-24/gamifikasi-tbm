<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBRGNL4DL5L_x92vv6tI4Ysa9Q0qyKvjeQ",
            authDomain: "pkm-pm-def08.firebaseapp.com",
            databaseURL: "https://pkm-pm-def08-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pkm-pm-def08",
            storageBucket: "pkm-pm-def08.firebasestorage.app",
            messagingSenderId: "1077227616889",
            appId: "1:1077227616889:web:9ce3a57e3d46012acab2a8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        let currentUser = null, userData = {};

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                get(ref(db, 'users/' + user.uid)).then(s => userData = s.val());
            } else window.location.href = "../index.html";
        });

        document.getElementById('tglBaca').valueAsDate = new Date();

        document.getElementById('laporForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!currentUser) return;
            
            const judul = document.getElementById('judulBuku').value;
            const ringkasan = document.getElementById('ringkasan').value;

            Swal.fire({title:'Mengirim...', didOpen:()=>Swal.showLoading()});

            try {
                // 1. Kirim Laporan ke Admin
                await push(ref(db, 'reports'), {
                    uid: currentUser.uid,
                    userName: userData.fullName || currentUser.displayName,
                    bookTitle: judul,
                    date: document.getElementById('tglBaca').value,
                    summary: ringkasan,
                    status: 'pending',
                    timestamp: Date.now()
                });

                // 2. CATAT LOG DI DASHBOARD (Langsung muncul "Mengirim Laporan")
                await push(ref(db, `logs/${currentUser.uid}`), {
                    activity: "Mengirim Laporan Baca",
                    points: 0, // Poin 0 dulu karena belum di-acc
                    date: new Date().toLocaleDateString('id-ID')
                });

                Swal.fire('Terkirim!', 'Tunggu verifikasi admin ya.', 'success').then(() => window.location.href = 'index.html');
            } catch(err) {
                Swal.fire('Gagal', err.message, 'error');
            }
        });
    </script>
