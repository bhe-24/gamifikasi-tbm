<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Detail Buku</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #fff; padding-bottom: 80px; }
        
        /* HEADER ARTISTIK */
        .preview-header {
            position: relative; height: 300px; overflow: hidden;
            background: #eee;
        }
        
        .bg-blur {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            filter: blur(20px) brightness(0.7); transform: scale(1.1);
        }

        .nav-top {
            position: absolute; top: 15px; left: 15px; z-index: 10;
        }
        .btn-circle {
            width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.3); color: white;
            display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px);
            cursor: pointer;
        }

        /* CONTAINER BUKU */
        .book-container {
            position: relative; margin-top: -120px; padding: 0 20px;
            display: flex; flex-direction: column; align-items: center; z-index: 5;
        }

        .main-cover {
            width: 140px; height: 210px; object-fit: cover; border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 2px solid white;
        }

        .book-meta { text-align: center; margin-top: 15px; width: 100%; }
        .b-title { font-weight: 700; font-size: 1.2rem; color: #333; line-height: 1.3; margin-bottom: 5px; }
        .b-author { color: #666; font-size: 0.9rem; margin-bottom: 10px; }
        .b-badge { background: #F3E5F5; color: #8E24AA; padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }

        .synopsis-area {
            margin: 20px 20px; padding: 20px; background: #FAFAFA; border-radius: 15px;
            color: #555; font-size: 0.9rem; line-height: 1.7; text-align: justify;
        }

        /* PERBAIKAN SINOPSIS AGAR RAPI (CSS Line Clamp) */
        #bookDesc {
            display: -webkit-box;
            -webkit-line-clamp: 6; /* Batasi maksimal 6 baris */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Sembunyikan gambar di preview sinopsis agar tidak merusak layout */
        #bookDesc img { display: none; }

        /* TOMBOL FLOAT */
        .float-action {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 15px 20px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 99;
        }
        .btn-read-now {
            width: 100%; padding: 12px; background: #8E24AA; color: white;
            border-radius: 50px; border: none; font-weight: 700;
            box-shadow: 0 4px 15px rgba(142, 36, 170, 0.4);
            transition: transform 0.2s;
        }
        .btn-read-now:active { transform: scale(0.98); }
    </style>
</head>
<body>

    <div class="preview-header">
        <div class="bg-blur" id="bgBlur"></div>
        <div class="nav-top">
            <div class="btn-circle" onclick="history.back()"><i class="fas fa-arrow-left"></i></div>
        </div>
    </div>

    <div class="book-container">
        <img src="https://placehold.co/140x210" id="mainCover" class="main-cover">
        <div class="book-meta">
            <div class="b-title" id="bookTitle">Memuat...</div>
            <div class="b-author" id="bookAuthor">...</div>
            <span class="b-badge" id="bookCat">Kategori</span>
        </div>
    </div>

    <div class="synopsis-area">
        <h6 style="font-weight:700; color:#333;">Sinopsis</h6>
        <div id="bookDesc">...</div>
        <small class="text-primary mt-2 d-block" style="cursor:pointer;" onclick="document.getElementById('btnRead').click()">Baca Selengkapnya &rarr;</small>
    </div>

    <div class="float-action">
        <button class="btn-read-now" id="btnRead">
            MULAI BACA <i class="fas fa-book-reader ms-2"></i>
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBRGNL4DL5L_x92vv6tI4Ysa9Q0qyKvjeQ",
            authDomain: "pkm-pm-def08.firebaseapp.com",
            databaseURL: "https://pkm-pm-def08-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pkm-pm-def08",
            storageBucket: "pkm-pm-def08.firebasestorage.app",
            messagingSenderId: "1077227616889",
            appId: "1:1077227616889:web:9ce3a57e3d46012acab2a8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');

        if(id) {
            // Cek apakah ini Buku (Admin) atau Karya (Warga)
            let path = 'books/' + id;
            if(id.startsWith('WORK_')) {
                path = 'works/' + id.replace('WORK_', '');
            }

            get(ref(db, path)).then(snap => {
                if(snap.exists()) {
                    const d = snap.val();
                    
                    // Set Data Tampilan
                    document.getElementById('bgBlur').style.backgroundImage = `url('${d.coverUrl}')`;
                    document.getElementById('mainCover').src = d.coverUrl;
                    document.getElementById('bookTitle').innerText = d.title;
                    document.getElementById('bookAuthor').innerText = d.author || d.authorName; // Support untuk Karya Warga
                    document.getElementById('bookCat').innerText = d.category || "Karya Warga";
                    
                    // PERBAIKAN DI SINI: Gunakan innerHTML agar tag HTML (bold, italic) terbaca
                    // Kita tidak pakai .substring() lagi agar tag HTML tidak rusak
                    document.getElementById('bookDesc').innerHTML = d.content;
                    
                    document.getElementById('btnRead').onclick = () => window.location.href = `baca.html?id=${id}`;
                }
            });
        }
    </script>
</body>
</html>
