<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pustaka Digital</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --theme-color: #D8BFD8; --theme-dark: #8E24AA; --bg-color: #F3E5F5; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); padding-bottom: 60px; margin: 0; }

        /* HEADER */
        .page-header {
            background: linear-gradient(135deg, #CE93D8, #AB47BC);
            padding: 15px 20px; display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 100; color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
        }
        .back-btn { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }
        .page-title { font-weight: 700; font-size: 1.1rem; }
        
        /* LOGO KECIL DI HEADER */
        .header-logo-small {
            width: 35px; height: 35px; 
            background: white; border-radius: 50%; padding: 2px;
            object-fit: contain; 
        }

        /* BANNER */
        .banner-wrapper { margin: 20px; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); background: #fff; min-height: 120px; }
        .banner-img { width: 100%; height: auto; display: block; }

        /* SEARCH */
        .search-box { margin: 0 20px 20px 20px; position: relative; }
        .search-input { width: 100%; border-radius: 25px; border: none; padding: 12px 20px 12px 45px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); outline: none; color: #444; }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }

        /* KATEGORI */
        .category-section { margin-bottom: 25px; padding-left: 20px; animation: fadeIn 0.5s; }
        .cat-title { font-weight: 700; color: #6A1B9A; margin-bottom: 10px; border-left: 4px solid #AB47BC; padding-left: 10px; font-size: 1rem; }
        .book-scroller { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 15px; padding-right: 20px; scrollbar-width: none; }
        .book-scroller::-webkit-scrollbar { display: none; }

        /* KARTU BUKU */
        .book-card { min-width: 130px; width: 130px; display: flex; flex-direction: column; cursor: pointer; transition: transform 0.2s; }
        .book-card:active { transform: scale(0.95); }
        .book-cover { width: 100%; height: 190px; border-radius: 10px; object-fit: cover; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 8px; background: #ddd; }
        .book-title { font-size: 0.85rem; font-weight: 600; color: #333; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 2.6em; }
        .book-author { font-size: 0.75rem; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .footer-text { text-align: center; color: #aaa; font-size: 0.75rem; margin-top: 20px; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body>

    <div class="page-header">
        <button class="back-btn" onclick="window.location.href='index.html'"><i class="fas fa-arrow-left"></i></button>
        <div class="page-title">Pustaka Digital</div>
        <img src="https://placehold.co/100?text=Logo" id="headerLogo" class="header-logo-small">
    </div>

    <div class="banner-wrapper">
        <img src="https://placehold.co/600x200/CE93D8/ffffff?text=Selamat+Membaca" id="bannerImg" class="banner-img">
    </div>

    <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="searchInput" class="search-input" placeholder="Cari judul buku atau penulis...">
    </div>

    <div id="contentArea">
        <div class="text-center p-5 text-muted">
            <i class="fas fa-spinner fa-spin fa-2x mb-2" style="color:#AB47BC;"></i><br>Sedang mengambil buku...
        </div>
    </div>

    <div class="footer-text">&copy; 2026 TBM Digital</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG SERVER SINGAPURA
        const firebaseConfig = {
            apiKey: "AIzaSyBRGNL4DL5L_x92vv6tI4Ysa9Q0qyKvjeQ",
            authDomain: "pkm-pm-def08.firebaseapp.com",
            databaseURL: "https://pkm-pm-def08-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pkm-pm-def08",
            storageBucket: "pkm-pm-def08.firebasestorage.app",
            messagingSenderId: "1077227616889",
            appId: "1:1077227616889:web:9ce3a57e3d46012acab2a8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let rawBooks = [];
        let rawWorks = []; 
        let combinedData = [];

        // 1. LOAD SETTINGS
        onValue(ref(db, 'settings'), snap => {
            const val = snap.val();
            if(val) {
                if(val.bannerBacaUrl) document.getElementById('bannerImg').src = val.bannerBacaUrl;
                if(val.logoUrl) document.getElementById('headerLogo').src = val.logoUrl;
            }
        });

        // 2. Load Buku Admin
        onValue(ref(db, 'books'), snap => {
            rawBooks = [];
            if(snap.exists()) {
                snap.forEach(c => {
                    // Ambil timestamp juga agar bisa disortir
                    rawBooks.push({ 
                        ...c.val(), 
                        type: 'book', 
                        id: c.key,
                        timestamp: c.val().timestamp || 0 // Default 0 jika data lama belum ada tanggal
                    });
                });
            }
            mergeAndRender();
        });

        // 3. Load Karya Warga
        onValue(ref(db, 'works'), snap => {
            rawWorks = [];
            if(snap.exists()) {
                snap.forEach(c => {
                    const val = c.val();
                    if(val.status === 'published') {
                        rawWorks.push({
                            type: 'work',
                            id: c.key,
                            title: val.title,
                            author: val.authorName, 
                            category: "Karya Warga", 
                            coverUrl: "https://placehold.co/130x190/FB8C00/ffffff?text=Karya", 
                            content: val.content,
                            timestamp: val.timestamp || 0 // Ambil Timestamp dari karya
                        });
                    }
                });
            }
            mergeAndRender();
        });

        function mergeAndRender() {
            // Gabungkan data
            combinedData = [...rawBooks, ...rawWorks];

            // LOGIKA SORTING BARU: URUTKAN BERDASARKAN TIMESTAMP (TERBARU DI ATAS/KIRI)
            combinedData.sort((a, b) => b.timestamp - a.timestamp);

            renderContent(combinedData);
        }

        function renderContent(items) {
            const container = document.getElementById('contentArea');
            container.innerHTML = '';

            if (items.length === 0) {
                container.innerHTML = '<div class="text-center p-5 text-muted">Belum ada bacaan.</div>';
                return;
            }

            const categories = {};
            // Grouping tapi urutan array di dalamnya tetap terjaga (karena sudah disortir sebelumnya)
            items.forEach(item => {
                const catName = item.category || "Umum";
                if (!categories[catName]) categories[catName] = [];
                categories[catName].push(item);
            });

            // Render per Kategori
            Object.keys(categories).forEach(cat => {
                const itemsInCat = categories[cat];
                let itemsHtml = '';

                itemsInCat.forEach(b => {
                    let targetUrl = "";
                    if (b.type === 'work') {
                        targetUrl = `baca.html?id=WORK_${b.id}`;
                    } else {
                        targetUrl = `preview-buku.html?id=${b.id}`;
                    }

                    itemsHtml += `
                        <div class="book-card" onclick="window.location.href='${targetUrl}'">
                            <img src="${b.coverUrl}" class="book-cover" onerror="this.src='https://placehold.co/130x190?text=Cover'">
                            <div class="book-title">${b.title}</div>
                            <div class="book-author">${b.author}</div>
                        </div>
                    `;
                });

                container.innerHTML += `
                    <div class="category-section">
                        <div class="cat-title">${cat} <span class="badge bg-light text-dark border ms-1" style="font-size:0.7rem">${itemsInCat.length}</span></div>
                        <div class="book-scroller">${itemsHtml}</div>
                    </div>
                `;
            });
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const key = e.target.value.toLowerCase();
            const filtered = combinedData.filter(item => 
                (item.title||"").toLowerCase().includes(key) || (item.author||"").toLowerCase().includes(key)
            );
            renderContent(filtered);
        });
    </script>
</body>
</html>
