<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - TBM Digital</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* CSS CUSTOM - TEMA BIRU FRESH */
        :root {
            --primary-blue: #1565C0;
            --light-blue-bg: #E3F2FD;
            --card-bg: #FFFFFF;
            --gold: #FFD700;
            --silver: #C0C0C0;
            --bronze: #CD7F32;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light-blue-bg);
            padding-bottom: 80px; 
            margin: 0;
            min-height: 100vh;
        }

        /* HEADER */
        .dashboard-header {
            background: linear-gradient(135deg, #1565C0, #42A5F5);
            padding: 15px 20px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom-left-radius: 25px; border-bottom-right-radius: 25px;
            box-shadow: 0 4px 15px rgba(21, 101, 192, 0.2);
            position: sticky; top: 0; z-index: 100;
        }

        .header-left { display: flex; align-items: center; gap: 12px; }
        .header-logo { width: 42px; height: 42px; background: white; border-radius: 50%; padding: 3px; object-fit: contain; }
        .header-title { font-size: 0.95rem; font-weight: 700; color: white; line-height: 1.2; }
        .profile-thumb { width: 45px; height: 45px; border-radius: 50%; border: 2px solid white; object-fit: cover; background-color: #eee; cursor: pointer;}

        /* BANNER */
        .banner-container {
            margin: 20px 15px; border-radius: 15px; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); min-height: 120px;
            background-color: #fff; display: flex; align-items: center; justify-content: center;
        }
        .banner-img { width: 100%; height: auto; display: block; }

        /* LEADERBOARD */
        .section-title { font-size: 1rem; font-weight: 700; color: #333; margin: 0 20px 10px 20px; }
        .leaderboard-card { background: var(--card-bg); margin: 0 15px 20px 15px; padding: 15px; border-radius: 15px; }

        .top-user {
            display: flex; align-items: center; margin-bottom: 10px; padding: 10px;
            border-radius: 12px; background: #F8F9FA; border: 1px solid #eee;
        }
        .rank-badge {
            width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; font-weight: 700; font-size: 0.85rem; margin-right: 12px; color: white; background-color: #90CAF9;
        }
        .rank-1 .rank-badge { background-color: var(--gold); }
        .rank-2 .rank-badge { background-color: var(--silver); }
        .rank-3 .rank-badge { background-color: var(--bronze); }
        .user-lb-info { flex-grow: 1; }
        .user-lb-name { font-size: 0.9rem; font-weight: 600; color: #444; }
        .user-lb-points { font-size: 0.8rem; color: var(--primary-blue); font-weight: 700; }

        /* POSISI USER (INI YANG KITA PERBAIKI) */
        .my-rank-bar {
            background: var(--primary-blue); color: white; 
            margin: 0 15px 25px 15px; padding: 15px 20px;
            border-radius: 15px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 5px 15px rgba(21, 101, 192, 0.3);
            position: relative; overflow: hidden;
        }
        /* Efek hiasan background */
        .my-rank-bar::after {
            content: ""; position: absolute; right: -20px; bottom: -20px;
            width: 80px; height: 80px; background: rgba(255,255,255,0.1);
            border-radius: 50%; pointer-events: none;
        }

        /* MENU GRID */
        .menu-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 0 15px 25px 15px; }
        .menu-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #555; text-align: center; }
        .menu-icon-box {
            width: 55px; height: 55px; background: white; border-radius: 18px;
            display: flex; align-items: center; justify-content: center; font-size: 1.4rem; margin-bottom: 8px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        .menu-label { font-size: 0.7rem; font-weight: 600; line-height: 1.2; }

        /* FOOTER FIXED */
        .app-footer {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white;
            text-align: center; font-size: 0.75rem; color: #888; padding: 10px 0;
            border-top: 1px solid #eee; z-index: 999;
        }
        .app-footer a { color: var(--primary-blue); text-decoration: none; font-weight: 600; }
    </style>
</head>
<body>

    <header class="dashboard-header">
        <div class="header-left">
            <img src="https://i.ibb.co.com/m50m25d/image-removebg-preview-13.png" alt="Logo" class="header-logo" id="headerLogo">
            <div class="header-title">TAMAN BACAAN<br>MASYARAKAT</div>
        </div>
        <img src="https://i.ibb.co/5r2M63R/person-placeholder.png" alt="Profil" class="profile-thumb" id="userProfilePic" onclick="window.location.href='profile.html'">
    </header>

    <div class="banner-container">
        <img src="https://placehold.co/600x200/90CAF9/ffffff?text=Selamat+Datang!" alt="Banner" class="banner-img" id="dynamicBanner">
    </div>

    <h3 class="section-title"><i class="fas fa-trophy text-warning"></i> Top Pembaca Hari Ini</h3>
    <div class="leaderboard-card" id="topThreeContainer">
        <div class="text-center text-muted small py-3">
            <i class="fas fa-spinner fa-spin"></i> Memuat...
        </div>
    </div>

    <div class="my-rank-bar">
        <div class="d-flex align-items-center">
            <div id="myRankBadge" style="background:white; color:#1565C0; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:1.2rem; margin-right:15px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                -
            </div>
            <div>
                <span style="font-size: 0.75rem; display:block; opacity:0.8;">Peringkat Kamu</span>
                <span style="font-weight:bold; font-size:1rem;" id="myRankName">Memuat...</span>
            </div>
        </div>
        <div style="text-align:right;">
             <div style="font-size: 1.2rem; font-weight:bold;" id="myRankPoints">0 XP</div>
             <span style="font-size: 0.7rem; opacity:0.8;">Total Poin</span>
        </div>
    </div>

    <div class="menu-grid">
        <a href="baca-online.html" class="menu-item"><div class="menu-icon-box" style="color: #1565C0;"><i class="fas fa-book-open"></i></div><span class="menu-label">Baca<br>Online</span></a>
        <a href="laporan.html" class="menu-item"><div class="menu-icon-box" style="color: #43A047;"><i class="fas fa-edit"></i></div><span class="menu-label">Lapor<br>Buku</span></a>
        <a href="form-cerita.html" class="menu-item"><div class="menu-icon-box" style="color: #FB8C00;"><i class="fas fa-pen-nib"></i></div><span class="menu-label">Kirim<br>Karya</span></a>
        <a href="hadiah.html" class="menu-item"><div class="menu-icon-box" style="color: #E91E63;"><i class="fas fa-gift"></i></div><span class="menu-label">Tukar<br>Poin</span></a>
    </div>

    <h3 class="section-title"><i class="fas fa-history text-secondary"></i> Aktivitas Terbaru</h3>
    <div style="margin: 0 15px;" id="historyContainer">
        <div class="text-center text-muted small py-3">Belum ada aktivitas.</div>
    </div>

    <div class="app-footer">
        &copy; 2026 TBM Digital. <a href="../privacy.html">Kebijakan Privasi</a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- KONFIGURASI SERVER SINGAPURA ---
        const firebaseConfig = {
            apiKey: "AIzaSyBRGNL4DL5L_x92vv6tI4Ysa9Q0qyKvjeQ",
            authDomain: "pkm-pm-def08.firebaseapp.com",
            databaseURL: "https://pkm-pm-def08-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pkm-pm-def08",
            storageBucket: "pkm-pm-def08.firebasestorage.app",
            messagingSenderId: "1077227616889",
            appId: "1:1077227616889:web:9ce3a57e3d46012acab2a8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // 1. CEK STATUS LOGIN & LOAD DATA
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User login, ambil data
                loadUserProfile(user);
                loadLeaderboardAndRank(user.uid); // <--- LOGIKA GABUNGAN
                loadUserHistory(user.uid);
                loadSettings(); 
            } else {
                window.location.href = "../index.html";
            }
        });

        // 2. FUNGSI LOAD BANNER & LOGO
        function loadSettings() {
            const settingsRef = ref(db, 'settings');
            onValue(settingsRef, (snap) => {
                const data = snap.val();
                if(data) {
                    if(data.bannerUrl) document.getElementById('dynamicBanner').src = data.bannerUrl;
                    if(data.logoUrl) document.getElementById('headerLogo').src = data.logoUrl;
                }
            });
        }

        // 3. LOAD PROFIL (Nama & Foto)
        function loadUserProfile(user) {
            const userRef = ref(db, 'users/' + user.uid);
            onValue(userRef, (snapshot) => {
                let pic = "https://i.ibb.co/5r2M63R/person-placeholder.png";
                let name = "User";

                if (snapshot.exists()) {
                    const data = snapshot.val();
                    pic = data.profilePic || pic;
                    name = data.username || data.fullName || name;
                }
                document.getElementById('userProfilePic').src = pic;
                document.getElementById('myRankName').innerText = name; // Update nama di bar biru
            });
        }

        // 4. LOAD LEADERBOARD & HITUNG PERINGKAT SAYA
        function loadLeaderboardAndRank(currentUid) {
            const container = document.getElementById('topThreeContainer');
            const usersRef = ref(db, 'users');

            onValue(usersRef, (snapshot) => {
                container.innerHTML = ''; 

                if (!snapshot.exists()) {
                    container.innerHTML = '<div class="text-center small py-3 text-muted">Belum ada pembaca lain.</div>';
                    return;
                }

                let users = [];
                snapshot.forEach((child) => {
                    const u = child.val();
                    users.push({
                        uid: child.key, // Simpan UID untuk pencarian
                        username: u.username || u.fullName || "User",
                        xp: u.xp || 0,
                        pic: u.profilePic || "https://i.ibb.co/5r2M63R/person-placeholder.png"
                    });
                });

                // Urutkan dari XP Terbesar
                users.sort((a, b) => b.xp - a.xp);

                // A. TAMPILKAN TOP 3
                users.slice(0, 3).forEach((u, i) => {
                    const rankClass = i === 0 ? 'rank-1' : (i === 1 ? 'rank-2' : 'rank-3');
                    const crown = i === 0 ? '<i class="fas fa-crown text-warning ms-auto"></i>' : '';
                    
                    const html = `
                        <div class="top-user ${rankClass}">
                            <div class="rank-badge">${i + 1}</div>
                            <img src="${u.pic}" style="width:35px; height:35px; border-radius:50%; margin-right:10px; object-fit:cover;">
                            <div class="user-lb-info">
                                <span class="user-lb-name">${u.username}</span>
                                <span class="user-lb-points">${u.xp} XP</span>
                            </div>
                            ${crown}
                        </div>
                    `;
                    container.innerHTML += html;
                });

                // B. HITUNG POSISI SAYA (PERINGKAT BERAPA?)
                let myRank = "-";
                let myXP = 0;
                
                // Cari user saya ada di index berapa
                const myIndex = users.findIndex(u => u.uid === currentUid);
                
                if(myIndex !== -1) {
                    myRank = myIndex + 1; // Karena index mulai dari 0
                    myXP = users[myIndex].xp;
                }

                // Update Tampilan Bar Biru
                document.getElementById('myRankBadge').innerText = "#" + myRank;
                document.getElementById('myRankPoints').innerText = myXP + " XP";
            });
        }

        // 5. LOAD HISTORY (RIWAYAT)
        function loadUserHistory(uid) {
            const logsRef = ref(db, `logs/${uid}`);
            const logsQuery = query(logsRef, limitToLast(5));
            const container = document.getElementById('historyContainer');

            onValue(logsQuery, (snapshot) => {
                if (!snapshot.exists()) {
                    container.innerHTML = '<div class="text-center text-muted small py-3">Belum ada aktivitas. Yuk baca buku!</div>';
                    return;
                }
                
                const logs = [];
                snapshot.forEach(c => logs.push(c.val()));
                logs.reverse(); 

                container.innerHTML = '';
                logs.forEach(log => {
                    let pointColor = '#888';
                    let pointSign = '';
                    if(log.points > 0) { pointColor = '#4CAF50'; pointSign = '+'; }
                    if(log.points < 0) { pointColor = '#F44336'; pointSign = ''; }

                    container.innerHTML += `
                        <div style="background:white; padding:10px; border-radius:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; border-left:4px solid ${pointColor}; box-shadow:0 2px 5px rgba(0,0,0,0.03);">
                            <div>
                                <div style="font-weight:600; font-size:0.85rem; color:#444;">${log.activity || "Aktivitas"}</div>
                                <div style="font-size:0.7rem; color:#999;">${log.date || ""}</div>
                            </div>
                            <div style="font-weight:bold; font-size:0.9rem; color:${pointColor};">
                                ${log.points !== 0 ? pointSign + log.points + ' XP' : ''}
                            </div>
                        </div>
                    `;
                });
            });
        }
    </script>
</body>
</html>
