<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Masuk - TBM Digital</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* 1. VISUAL: Biru Muda Fresh */
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* Kunci layar */
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg, #E3F2FD 0%, #BBDEFB 100%);
            position: relative;
        }

        /* Animasi Ombak Halus di Bawah */
        .wave-bg {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30vh;
            background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 1440 320" xmlns="http://www.w3.org/2000/svg"><path fill="%232196F3" fill-opacity="0.1" d="M0,224L48,213.3C96,203,192,181,288,181.3C384,181,480,203,576,224C672,245,768,267,864,261.3C960,256,1056,224,1152,197.3C1248,171,1344,149,1392,138.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
            background-size: cover;
            background-repeat: no-repeat;
            z-index: 0;
        }

        /* Container Kartu */
        .login-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 25px 25px; /* Padding lebih kecil biar muat */
            width: 85%;
            max-width: 380px;
            box-shadow: 0 15px 35px rgba(33, 150, 243, 0.15);
            text-align: center;
            z-index: 10;
            border: 1px solid rgba(255, 255, 255, 0.8);
            /* Pastikan muat di layar kecil */
            max-height: 90vh;
            overflow-y: auto; 
        }

        /* Scrollbar sembunyi biar rapi */
        .login-card::-webkit-scrollbar { display: none; }

        /* Logo & Header */
        .app-logo {
            width: 70px; /* Diperkecil sedikit */
            height: 70px;
            object-fit: contain;
            margin-bottom: 5px;
            border-radius: 50%;
            background: white;
            padding: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .app-title {
            font-weight: 700;
            color: #1565C0; /* Biru Tua */
            font-size: 1.1rem;
            margin-bottom: 15px;
            letter-spacing: 0.5px;
        }

        h5.section-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
            font-weight: 500;
        }

        /* Form Input Lebih Padat */
        .form-control {
            border-radius: 30px; /* Membulat penuh */
            padding: 10px 20px;
            font-size: 0.9rem;
            margin-bottom: 10px; /* Jarak antar input diperkecil */
            border: 1px solid #BBDEFB;
            background: #F0F8FF;
        }

        .form-control:focus {
            border-color: #2196F3;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        /* Tombol Menarik (Gradient) */
        .btn-custom {
            width: 100%;
            padding: 10px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 0.95rem;
            border: none;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-gradient {
            background: linear-gradient(90deg, #2196F3 0%, #00BCD4 100%);
            color: white;
        }

        .btn-gradient:active {
            transform: scale(0.96);
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
        }

        /* Toggle Link (Daftar/Masuk) */
        .toggle-text {
            margin-top: 15px;
            font-size: 0.8rem;
            color: #777;
        }

        .toggle-link {
            color: #1976D2;
            cursor: pointer;
            font-weight: 700;
            text-decoration: underline;
        }

        /* Helper */
        .d-none-custom { display: none; }
        
        /* Footer Hak Cipta */
        .footer-mini {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            font-size: 0.65rem;
            color: rgba(0,0,0,0.3);
            z-index: 10;
        }
    </style>
</head>
<body>

    <div class="wave-bg"></div>

    <div class="login-card">
        <img src="https://i.ibb.co.com/m50m25d/image-removebg-preview-13.png" alt="Logo" class="app-logo" id="dynamicLogo">
        
        <h2 class="app-title">Taman Bacaan<br>Masyarakat</h2>

        <div id="loginSection">
            <h5 class="section-title">Silakan Masuk</h5>
            <form id="loginForm">
                <input type="email" id="loginEmail" class="form-control" placeholder="Email (gmail / ac.id)" required>
                <input type="password" id="loginPassword" class="form-control" placeholder="Password" required>
                
                <div class="text-end mb-2">
                    <small><a href="#" class="text-secondary text-decoration-none" onclick="showForgot()" style="font-size: 0.75rem;">Lupa Password?</a></small>
                </div>

                <button type="submit" class="btn btn-custom btn-gradient">
                    MASUK <i class="fas fa-sign-in-alt ms-2"></i>
                </button>
            </form>
            <div class="toggle-text">
                Belum punya akun? <span class="toggle-link" onclick="showRegister()">Daftar Disini</span>
            </div>
        </div>

        <div id="registerSection" class="d-none-custom">
            <h5 class="section-title">Buat Akun Baru</h5>
            <form id="registerForm">
                <input type="text" id="regName" class="form-control" placeholder="Nama Lengkap" required>
                <input type="number" id="regAge" class="form-control" placeholder="Umur (Angka)" required>
                <input type="email" id="regEmail" class="form-control" placeholder="Email Aktif" required>
                <input type="password" id="regPassword" class="form-control" placeholder="Password (Min. 6 Digit)" required>

                <button type="submit" class="btn btn-custom btn-gradient">
                    DAFTAR SEKARANG
                </button>
            </form>
            <div class="toggle-text">
                Sudah punya akun? <span class="toggle-link" onclick="showLogin()">Masuk Saja</span>
            </div>
        </div>

        <div id="forgotSection" class="d-none-custom">
            <h5 class="section-title">Reset Password</h5>
            <p style="font-size: 0.75rem; color:#888; margin-bottom:10px;">Masukkan email, link reset akan dikirim.</p>
            <form id="forgotForm">
                <input type="email" id="forgotEmail" class="form-control" placeholder="Email Terdaftar" required>
                <button type="submit" class="btn btn-custom btn-gradient">
                    KIRIM LINK
                </button>
            </form>
            <div class="toggle-text">
                <span class="toggle-link" onclick="showLogin()">Batal</span>
            </div>
        </div>
    </div>

    <div class="footer-mini">&copy; 2026 TBM Digital Indonesia</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBRGNL4DL5L_x92vv6tI4Ysa9Q0qyKvjeQ",
            authDomain: "pkm-pm-def08.firebaseapp.com",
            projectId: "pkm-pm-def08",
            storageBucket: "pkm-pm-def08.firebasestorage.app",
            messagingSenderId: "1077227616889",
            appId: "1:1077227616889:web:9ce3a57e3d46012acab2a8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- NAVIGASI UI ---
        window.showRegister = () => {
            // Popup info kecil sebelum pindah (Opsional, biar interaktif)
            document.getElementById('loginSection').classList.add('d-none-custom');
            document.getElementById('forgotSection').classList.add('d-none-custom');
            document.getElementById('registerSection').classList.remove('d-none-custom');
        };

        window.showLogin = () => {
            document.getElementById('registerSection').classList.add('d-none-custom');
            document.getElementById('forgotSection').classList.add('d-none-custom');
            document.getElementById('loginSection').classList.remove('d-none-custom');
        };

        window.showForgot = () => {
            document.getElementById('loginSection').classList.add('d-none-custom');
            document.getElementById('registerSection').classList.add('d-none-custom');
            document.getElementById('forgotSection').classList.remove('d-none-custom');
        }

        // --- FUNGSI REGISTER ---
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('regName').value;
            const age = document.getElementById('regAge').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            // Validasi Sederhana
            if(password.length < 6) {
                Swal.fire({
                    icon: 'warning', title: 'Password Lemah',
                    text: 'Password minimal 6 karakter ya!',
                    confirmButtonColor: '#2196F3'
                });
                return;
            }

            // Tampilkan Loading
            Swal.fire({
                title: 'Sedang Mendaftar...',
                text: 'Tunggu sebentar ya.',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            try {
                // 1. Create Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // 2. Update Nama
                await updateProfile(user, { displayName: name });

                // 3. Simpan DB
                await set(ref(db, 'users/' + user.uid), {
                    fullName: name,
                    age: age,
                    email: email,
                    role: email.endsWith('@ac.id') ? 'admin' : 'user',
                    level: 1,
                    xp: 0,
                    badges: [],
                    createdAt: new Date().toISOString()
                });

                // Sukses
                Swal.fire({
                    icon: 'success',
                    title: 'Berhasil!',
                    text: 'Akunmu sudah jadi. Yuk login sekarang.',
                    confirmButtonColor: '#2196F3'
                }).then(() => {
                    showLogin();
                    document.getElementById('registerForm').reset();
                });

            } catch (error) {
                let msg = error.message;
                if(error.code === 'auth/email-already-in-use') msg = "Email ini sudah terdaftar loh.";
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal Daftar',
                    text: msg,
                    confirmButtonColor: '#d33'
                });
            }
        });

        // --- FUNGSI LOGIN ---
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            // Loading
            Swal.fire({
                title: 'Masuk...',
                timerProgressBar: true,
                didOpen: () => { Swal.showLoading(); }
            });

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    Swal.fire({
                        icon: 'success',
                        title: 'Hai, ' + (userCredential.user.displayName || 'Kawan'),
                        text: 'Selamat datang kembali!',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        // Routing
                        if (email.endsWith('@ac.id')) {
                            window.location.href = "admin/index.html"; 
                        } else {
                            window.location.href = "dashboard/index.html";
                        }
                    });
                })
                .catch((error) => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Tidak Bisa Masuk',
                        text: 'Email atau Password mungkin salah.',
                        confirmButtonColor: '#d33'
                    });
                });
        });

        // --- FUNGSI RESET PASS ---
        document.getElementById('forgotForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('forgotEmail').value;

            Swal.fire({
                title: 'Mengirim...',
                didOpen: () => { Swal.showLoading(); }
            });

            sendPasswordResetEmail(auth, email)
                .then(() => {
                    Swal.fire({
                        icon: 'success',
                        title: 'Terkirim!',
                        text: 'Cek kotak masuk/spam email kamu ya.',
                        confirmButtonColor: '#2196F3'
                    }).then(() => showLogin());
                })
                .catch((error) => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Gagal',
                        text: 'Email tidak ditemukan.',
                        confirmButtonColor: '#d33'
                    });
                });
        });

    </script>
</body>
</html>
